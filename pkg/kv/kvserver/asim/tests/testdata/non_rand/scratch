# Attempt to reproduce https://cockroachlabs.slack.com/archives/C0KB9Q03D/p1718648441301689
# The following zone config is applied:
#   num_replicas = 5,
#   num_voters = 3,
#   constraints = '{+region=ap-southeast-2: 1, +region=eu-west-3: 1, +region=us-west-2: 1}',
#   voter_constraints = '[+region=us-west-2]',
#   lease_preferences = '[[+region=us-west-2], [+region=eu-west-3]]'
#
# The existing replica placement:
#   voters={4,1,8} non-voters={5,7} 
# With zone localities:
#   voters={us-west-2b,us-west-2a,eu-west-3c} non-voters={eu-west-3b,ap-southeast-2c}
#
# The node localities are:
#   1=region=us-west-2,zone=us-west-2a
#   2=region=eu-west-3,zone=eu-west-3a
#   3=region=ap-southeast-2,zone=ap-southeast-2a
#   4=region=us-west-2,zone=us-west-2b
#   5=region=eu-west-3,zone=eu-west-3b
#   6=region=ap-southeast-2,zone=ap-southeast-2b
#   7=region=ap-southeast-2,zone=ap-southeast-2c
#   8=region=eu-west-3,zone=eu-west-3c
#   9=region=us-west-2,zone=us-west-2c

gen_cluster nodes=9
----

set_locality node=1 locality=region=us-west-2,zone=us-west-2a
----

set_locality node=2 locality=region=eu-west-3,zone=eu-west-3a
----

set_locality node=3 locality=region=ap-southeast-2,zone=ap-southeast-2a
----

set_locality node=4 locality=region=us-west-2,zone=us-west-2b
----

set_locality node=5 locality=region=eu-west-3,zone=eu-west-3b
----

set_locality node=6 locality=region=ap-southeast-2,zone=ap-southeast-2b
----

set_locality node=7 locality=region=ap-southeast-2,zone=ap-southeast-2c
----

set_locality node=8 locality=region=eu-west-3,zone=eu-west-3c
----

set_locality node=9 locality=region=us-west-2,zone=us-west-2c
----

gen_ranges ranges=5 repl_factor=5
----

# Setup the zone config to match the existing replica placement.
# voters={us-west-2b,us-west-2a,eu-west-3c}
# non-voters={eu-west-3b,ap-southeast-2c}, 2 voters in each of us-west-2 and
# eu-west-3, 1 non-voter in ap-southeast-2.
set_span_config  
[0,10000): num_replicas=5 num_voters=3 constraints={'+region=ap-southeast-2':1,'+region=eu-west-3':2,'+region=us-west-2':2} voter_constraints={'+region=us-west-2':2,'+region=eu-west-3':1}
----

# Apply the actual zone config, as described in the comment at the top of this
# test, note us-west-2 is underspecified, requiring only 1 replica, despite
# needing 3 voters.
set_span_config  delay=20m
[0,10000): num_replicas=5 num_voters=3 constraints={'+region=ap-southeast-2':1,'+region=eu-west-3':1,'+region=us-west-2':1} voter_constraints={'+region=us-west-2'}
----

assertion type=conformance under=0 over=0 unavailable=0 violating=0
----

eval duration=30m
----
OK

topology
----
ap-southeast-2
  ap-southeast-2a
  │ └── [3]
  ap-southeast-2b
  │ └── [6]
  ap-southeast-2c
  │ └── [7]
eu-west-3
  eu-west-3a
  │ └── [2]
  eu-west-3b
  │ └── [5]
  eu-west-3c
  │ └── [8]
us-west-2
  us-west-2a
    └── [1]
  us-west-2b
    └── [4]
  us-west-2c
    └── [9]

# vim:ft=sh
